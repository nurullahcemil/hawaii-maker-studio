{%- doc -%}
  Dynamic Image Gallery Section
  Uses product metafields to display a customizable image gallery
  
  Metafield Setup Required:
  1. Go to Shopify Admin > Settings > Metafields > Products
  2. Create a new metafield:
     - Namespace: custom
     - Key: gallery_images  
     - Type: List of files
     - Content type: Image
  3. Add images to products via the metafield in product admin
{%- enddoc -%}

{% liquid
  # Try multiple ways to access the product
  assign product_resource = product
  if product_resource == blank
    assign product_resource = closest.product
  endif
  if product_resource == blank and template.name == 'product'
    assign product_resource = collections.all.products.first
  endif
  
  # Get gallery images from metafield with multiple fallback attempts
  assign gallery_images = product_resource.metafields.custom.gallery_images.value
  if gallery_images == blank
    assign gallery_images = product_resource.metafields.custom.gallery_images
  endif
  if gallery_images == blank
    assign gallery_images = product_resource.metafields['custom.gallery_images'].value
  endif
  if gallery_images == blank
    assign gallery_images = product_resource.metafields['custom.gallery_images']
  endif
  
  # Fallback to product images if no metafield images
  if gallery_images == blank
    assign gallery_images = product_resource.images
  endif
  
  # Debug: force show something if we have a product
  if gallery_images == blank and product_resource != blank
    assign gallery_images = product_resource.images
  endif
%}

<div class="section section--{{ section.settings.section_width }} color-{{ section.settings.color_scheme }}">
  <div class="dynamic-gallery spacing-style" 
       style="
         {% render 'spacing-style', settings: section.settings %}
         --columns-mobile: {{ section.settings.columns_mobile | default: 2 }};
         --columns-tablet: {{ section.settings.columns_tablet | default: 3 }};
         --columns-desktop: {{ section.settings.columns_desktop | default: 4 }};
         --image-radius: {{ section.settings.image_radius | default: 0 }}px;
       ">
    
    {% if section.settings.show_title and section.settings.gallery_title != blank %}
      <h2 class="dynamic-gallery__title h3 text-center">{{ section.settings.gallery_title }}</h2>
    {% endif %}

      <div class="dynamic-gallery__container" data-gallery-layout="{{ section.settings.gallery_layout }}">
        
        {% if section.settings.gallery_layout == 'slideshow' %}
          <!-- Slideshow Layout -->
          <slideshow-component class="dynamic-gallery__slideshow">
            <div class="slideshow" data-autoplay="{{ section.settings.autoplay }}" data-autoplay-speed="{{ section.settings.autoplay_speed }}">
              <div class="slideshow__slides">
                {% for image in gallery_images limit: section.settings.max_images %}
                  <div class="slideshow__slide dynamic-gallery__slide" {% if forloop.first %}data-active="true"{% endif %}>
                    <div class="dynamic-gallery__image-container">
                      {% if section.settings.enable_zoom %}
                        <button type="button" class="dynamic-gallery__zoom-btn" aria-label="Zoom image" data-image-index="{{ forloop.index0 }}">
                      {% endif %}
                      
                      <img 
                        src="{{ image | image_url: width: 800 }}"
                        alt="{{ image.alt | default: product_resource.title | escape }}"
                        width="{{ image.width }}"
                        height="{{ image.height }}"
                        loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                        class="dynamic-gallery__image"
                        sizes="(min-width: 750px) calc(100vw - 22rem), calc(100vw - 3rem)"
                      >
                      
                      {% if section.settings.enable_zoom %}
                        </button>
                      {% endif %}
                    </div>
                    
                    {% if section.settings.show_captions and image.alt != blank %}
                      <p class="dynamic-gallery__caption">{{ image.alt }}</p>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
              
              {% if gallery_images.size > 1 %}
                <button class="slideshow__btn slideshow__btn--prev" aria-label="Previous image">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="slideshow__btn slideshow__btn--next" aria-label="Next image">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              {% endif %}
            </div>
            
            {% if gallery_images.size > 1 and section.settings.show_dots %}
              <div class="slideshow__dots">
                {% for image in gallery_images limit: section.settings.max_images %}
                  <button class="slideshow__dot{% if forloop.first %} slideshow__dot--active{% endif %}" data-slide="{{ forloop.index0 }}" aria-label="Go to slide {{ forloop.index }}"></button>
                {% endfor %}
              </div>
            {% endif %}
          </slideshow-component>
          
        {% else %}
          <!-- Grid Layout -->
          <div class="dynamic-gallery__grid dynamic-gallery__grid--{{ section.settings.gallery_layout }}">
            {% for image in gallery_images limit: section.settings.max_images %}
              <div class="dynamic-gallery__grid-item">
                <div class="dynamic-gallery__image-container">
                  {% if section.settings.enable_zoom %}
                    <button type="button" class="dynamic-gallery__zoom-btn" aria-label="Zoom image" data-image-index="{{ forloop.index0 }}">
                  {% endif %}
                  
                  <img 
                    src="{{ image | image_url: width: 600 }}"
                    alt="{{ image.alt | default: product_resource.title | escape }}"
                    width="{{ image.width }}"
                    height="{{ image.height }}"
                    loading="{% if forloop.index <= 4 %}eager{% else %}lazy{% endif %}"
                    class="dynamic-gallery__image"
                    sizes="(min-width: 1200px) calc((100vw - 22rem) / {{ section.settings.columns_desktop }}), (min-width: 750px) calc((100vw - 3rem) / {{ section.settings.columns_tablet }}), calc((100vw - 3rem) / {{ section.settings.columns_mobile }})"
                  >
                  
                  {% if section.settings.enable_zoom %}
                    </button>
                  {% endif %}
                </div>
                
                {% if section.settings.show_captions and image.alt != blank %}
                  <p class="dynamic-gallery__caption">{{ image.alt }}</p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {% if section.settings.enable_zoom %}
        <!-- Zoom Modal -->
        <div class="dynamic-gallery__zoom-modal" id="gallery-zoom-{{ section.id }}" aria-hidden="true">
          <div class="dynamic-gallery__zoom-overlay">
            <div class="dynamic-gallery__zoom-content">
              <button class="dynamic-gallery__zoom-close" aria-label="Close zoom">&times;</button>
              <img class="dynamic-gallery__zoom-image" src="" alt="">
              <div class="dynamic-gallery__zoom-nav">
                <button class="dynamic-gallery__zoom-prev" aria-label="Previous image">&larr;</button>
                <button class="dynamic-gallery__zoom-next" aria-label="Next image">&rarr;</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

{% stylesheet %}
  .dynamic-gallery {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
  }

  .dynamic-gallery__title {
    margin-bottom: var(--spacing-lg);
    text-align: center;
  }

  .dynamic-gallery__container {
    position: relative;
  }

  /* Grid Layouts */
  .dynamic-gallery__grid {
    display: grid;
    gap: var(--spacing-md);
    width: 100%;
  }

  .dynamic-gallery__grid--grid-2 {
    grid-template-columns: repeat(var(--columns-mobile), 1fr);
  }

  .dynamic-gallery__grid--grid-3 {
    grid-template-columns: repeat(var(--columns-mobile), 1fr);
  }

  .dynamic-gallery__grid--grid-4 {
    grid-template-columns: repeat(var(--columns-mobile), 1fr);
  }

  .dynamic-gallery__grid--masonry {
    position: relative;
    width: 100%;
  }

  .dynamic-gallery__grid--masonry .dynamic-gallery__grid-item {
    position: absolute;
    width: calc((100% - (var(--columns-mobile) - 1) * 16px) / var(--columns-mobile));
    transition: transform 0.3s ease;
  }

  .dynamic-gallery__grid--masonry .dynamic-gallery__grid-item:hover {
    transform: translateY(-2px);
    z-index: 10;
  }

  @media screen and (min-width: 750px) {
    .dynamic-gallery__grid--grid-2 {
      grid-template-columns: repeat(var(--columns-tablet), 1fr);
      gap: 20px;
    }

    .dynamic-gallery__grid--grid-3 {
      grid-template-columns: repeat(var(--columns-tablet), 1fr);
      gap: 20px;
    }

    .dynamic-gallery__grid--grid-4 {
      grid-template-columns: repeat(var(--columns-tablet), 1fr);
      gap: 20px;
    }
  }

  @media screen and (min-width: 990px) {
    .dynamic-gallery__grid--grid-2 {
      grid-template-columns: repeat(var(--columns-desktop), 1fr);
      gap: 24px;
    }

    .dynamic-gallery__grid--grid-3 {
      grid-template-columns: repeat(var(--columns-desktop), 1fr);
      gap: 24px;
    }

    .dynamic-gallery__grid--grid-4 {
      grid-template-columns: repeat(var(--columns-desktop), 1fr);
      gap: 24px;
    }
  }

  /* Clean Pinterest-Style Image Styling */
  .dynamic-gallery__image-container {
    position: relative;
    overflow: hidden;
    border-radius: var(--image-radius);
    background-color: var(--color-background);
    transition: transform 0.3s ease;
  }

  .dynamic-gallery__image-container:hover {
    transform: translateY(-2px);
  }

  .dynamic-gallery__image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s ease;
    border-radius: var(--image-radius);
  }

  .dynamic-gallery__zoom-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: zoom-in;
    width: 100%;
    height: 100%;
    border-radius: var(--image-radius);
    position: relative;
  }

  .dynamic-gallery__zoom-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0);
    transition: background 0.3s ease;
    border-radius: var(--image-radius);
    z-index: 1;
  }

  .dynamic-gallery__zoom-btn:hover::before {
    background: rgba(0, 0, 0, 0.1);
  }

  .dynamic-gallery__zoom-btn:hover .dynamic-gallery__image {
    transform: scale(1.02);
  }

  .dynamic-gallery__caption {
    margin-top: 12px;
    font-size: 14px;
    color: var(--color-foreground-75);
    text-align: left;
    line-height: 1.4;
    font-weight: 400;
  }

  /* Slideshow Styles */
  .dynamic-gallery__slideshow {
    position: relative;
  }

  .slideshow {
    position: relative;
    overflow: hidden;
    border-radius: {{ section.settings.image_radius | default: 8 }}px;
  }

  .slideshow__slides {
    display: flex;
    transition: transform 0.5s ease;
  }

  .slideshow__slide {
    min-width: 100%;
    display: none;
  }

  .slideshow__slide[data-active="true"] {
    display: block;
  }

  .slideshow__btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s ease;
    z-index: 2;
  }

  .slideshow__btn:hover {
    background: rgba(0, 0, 0, 0.7);
  }

  .slideshow__btn--prev {
    left: 10px;
  }

  .slideshow__btn--next {
    right: 10px;
  }

  .slideshow__dots {
    display: flex;
    justify-content: center;
    gap: var(--spacing-xs);
    margin-top: var(--spacing-md);
  }

  .slideshow__dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: none;
    background: var(--color-border);
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .slideshow__dot--active,
  .slideshow__dot:hover {
    background: var(--color-foreground);
  }

  /* Zoom Modal */
  .dynamic-gallery__zoom-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.9);
  }

  .dynamic-gallery__zoom-modal[aria-hidden="false"] {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .dynamic-gallery__zoom-overlay {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
  }

  .dynamic-gallery__zoom-image {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
  }

  .dynamic-gallery__zoom-close {
    position: absolute;
    top: -40px;
    right: 0;
    background: none;
    border: none;
    color: white;
    font-size: 30px;
    cursor: pointer;
  }

  .dynamic-gallery__zoom-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 100%;
    display: flex;
    justify-content: space-between;
    pointer-events: none;
  }

  .dynamic-gallery__zoom-prev,
  .dynamic-gallery__zoom-next {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 24px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    pointer-events: auto;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Dynamic Image Gallery",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "**Setup Instructions:** Go to Settings > Metafields > Products and create a metafield with namespace 'custom' and key 'gallery_images' of type 'List of files' (Images). Then add images to your products."
    },
    {
      "type": "header",
      "content": "Gallery Settings"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show gallery title",
      "default": true
    },
    {
      "type": "text",
      "id": "gallery_title",
      "label": "Gallery title",
      "default": "Product Gallery"
    },
    {
      "type": "select",
      "id": "gallery_layout",
      "label": "Gallery layout",
      "options": [
        {
          "value": "slideshow",
          "label": "Slideshow"
        },
        {
          "value": "grid-2",
          "label": "Grid - 2 columns"
        },
        {
          "value": "grid-3",
          "label": "Grid - 3 columns"
        },
        {
          "value": "grid-4",
          "label": "Grid - 4 columns"
        },
        {
          "value": "masonry",
          "label": "Masonry"
        }
      ],
      "default": "masonry"
    },
    {
      "type": "range",
      "id": "max_images",
      "label": "Maximum images to show",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 12
    },
    {
      "type": "header",
      "content": "Grid Columns"
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "Mobile columns",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "columns_tablet",
      "label": "Tablet columns",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 3
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Desktop columns",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Image Settings"
    },
    {
      "type": "range",
      "id": "image_radius",
      "label": "Image border radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "checkbox",
      "id": "show_captions",
      "label": "Show image captions",
      "info": "Uses image alt text as caption",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_zoom",
      "label": "Enable image zoom",
      "default": true
    },
    {
      "type": "header",
      "content": "Slideshow Settings"
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show slideshow dots",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-play slideshow",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Auto-play speed",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "default": 5
    },
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "full-width",
          "label": "Full width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Dynamic Image Gallery"
    }
  ]
}
{% endschema %}
