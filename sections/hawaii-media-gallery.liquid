{% comment %}
  Hawaii Maker Studio - Media Gallery Section
  Integrates media gallery functionality with Hawaii design language
{% endcomment %}

{%- liquid
  assign selected_variant = product.selected_or_first_available_variant
  assign available = selected_variant.available
  
  # Sort media to place videos third (same logic as original)
  assign video_media = product.media | where: "media_type", "video"
  assign external_video_media = product.media | where: "media_type", "external_video"
  assign image_media = product.media | where: "media_type", "image"
  
  # Get first two images
  assign first_two_images = image_media | slice: 0, 2
  # Get remaining images after first two
  assign remaining_images = image_media | slice: 2, 999
  
  # Combine: first two images + videos + remaining images
  assign sorted_media = first_two_images | concat: video_media | concat: external_video_media | concat: remaining_images
  
  # Determine collection URL based on event type (same logic)
  assign collection_url = ''
  assign collection_text = ''
  
  if product and product.metafields.custom.event_handle != blank
    assign event_handle = product.metafields.custom.event_handle.value
    assign event = shop.metaobjects.event[event_handle]
    
    if event and event.event_type.value != blank
      assign event_type_val = event.event_type.value | downcase
      
      if event_type_val contains 'honolulu'
        assign collection_url = '/collections/honolulu'
        assign collection_text = 'All Honolulu Classes'
      elsif event_type_val contains 'new york' or event_type_val contains 'nyc'
        assign collection_url = '/pages/team-building-events-nyc'
        assign collection_text = 'All NYC Classes'
      elsif event_type_val contains 'virtual'
        assign collection_url = '/collections/virtual'
        assign collection_text = 'All Virtual Classes'
      else
        assign collection_url = '/collections/workshops'
        assign collection_text = 'All Classes'
      endif
    endif
  endif
  
  # Fallback: Check product title/handle
  if collection_url == blank and product
    assign product_title_lower = product.title | downcase
    assign product_handle_lower = product.handle | downcase
    
    if product_title_lower contains 'honolulu' or product_handle_lower contains 'honolulu'
      assign collection_url = '/collections/honolulu'
      assign collection_text = 'All Honolulu Classes'
    elsif product_title_lower contains 'virtual' or product_handle_lower contains 'virtual'
      assign collection_url = '/collections/virtual'
      assign collection_text = 'All Virtual Classes'
    endif
  endif
-%}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="
    hawaii-media-gallery
    section
    section--{{ section.settings.section_width }}
    color-{{ section.settings.color_scheme }}
    spacing-style
  "
  style="{% render 'spacing-style', settings: section.settings %}"
>
  <div class="section-content-wrapper">
    
    {% if collection_url != blank %}
      <!-- Back to Collection Button using Hawaii design -->
      <div class="hawaii-gallery-nav">
        <a href="{{ collection_url }}" class="hawaii-back-button">
          <span class="svg-wrapper">
            {{ 'icon-arrow.svg' | inline_asset_content }}
          </span>
          {{ collection_text }}
        </a>
      </div>
    {% endif %}
    
    <!-- Media Gallery using Hawaii grid system -->
    <div 
      class="
        hawaii-gallery-container
        layout-panel-flex
        layout-panel-flex--{{ section.settings.gallery_layout }}
        spacing-style
      "
      style="
        {% render 'layout-panel-style', settings: section.settings %}
        --gap: {{ section.settings.image_gap }}px;
      "
      data-gallery-type="{{ section.settings.gallery_type }}"
      data-desktop-columns="{{ section.settings.desktop_columns }}"
      data-mobile-columns="{{ section.settings.mobile_columns }}"
    >
      {% if product and sorted_media.size > 0 %}
        {% for media in sorted_media %}
          <div 
            class="
              hawaii-media-item
              {% if forloop.first %}hawaii-media-featured{% endif %}
              {% if media.media_type == 'video' or media.media_type == 'external_video' %}hawaii-media-video{% endif %}
              border-style
              spacing-style
            "
            style="
              --border-radius: {{ section.settings.media_radius }}px;
              --border-width: {{ section.settings.border_width }}px;
              --border-style: {{ section.settings.border_style }};
              --border-color: rgb(var(--color-border-rgb) / {{ section.settings.border_opacity }}%);
            "
            data-media-index="{{ forloop.index0 }}"
            data-media-type="{{ media.media_type }}"
          >
            {% if media.media_type == 'video' %}
              <div class="hawaii-video-container">
                <video 
                  autoplay 
                  muted 
                  loop 
                  playsinline
                  preload="auto"
                  poster="{{ media.preview_image | image_url: width: 800 }}"
                  class="hawaii-video">
                  {% for source in media.sources %}
                    <source src="{{ source.url }}" type="{{ source.mime_type }}">
                  {% endfor %}
                </video>
                <button class="hawaii-video-controls" onclick="hawaiiToggleVideo(this)">
                  <span class="svg-wrapper">
                    {{ 'icon-pause.svg' | inline_asset_content }}
                  </span>
                </button>
              </div>
            {% elsif media.media_type == 'external_video' %}
              <div class="hawaii-video-container">
                {{ media | external_video_tag: autoplay: true, loop: true, muted: true, class: "hawaii-external-video" }}
                <button class="hawaii-video-controls" onclick="hawaiiToggleExternalVideo(this)">
                  <span class="svg-wrapper">
                    {{ 'icon-pause.svg' | inline_asset_content }}
                  </span>
                </button>
              </div>
            {% else %}
              <button 
                class="hawaii-image-button"
                onclick="hawaiiOpenModal('{{ media | image_url: width: 2048 }}', '{{ media.alt | escape }}')"
                aria-label="View larger image: {{ media.alt | escape }}"
              >
                {{
                  media
                  | image_url: width: 800
                  | image_tag:
                    loading: 'lazy',
                    alt: media.alt,
                    class: 'hawaii-media-image',
                    widths: '240, 352, 832, 1200, 1600',
                    sizes: '(min-width: 750px) calc((100vw - 2rem) / {{ section.settings.desktop_columns }}), calc((100vw - 2rem) / {{ section.settings.mobile_columns }})'
                }}
              </button>
            {% endif %}
            
            {% if media.alt != blank and section.settings.show_captions %}
              <div class="hawaii-media-caption">
                {{ media.alt }}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <!-- Fallback using Hawaii design -->
        <div class="hawaii-gallery-placeholder border-style spacing-style">
          <div class="hawaii-placeholder-content">
            <span class="svg-wrapper">
              {{ 'icon-add-to-cart.svg' | inline_asset_content }}
            </span>
            <p>Please select a product to display media gallery</p>
          </div>
        </div>
      {% endif %}
    </div>
    
    <!-- Gallery Navigation using Hawaii button style -->
    {% if sorted_media.size > section.settings.desktop_columns %}
      <div class="hawaii-gallery-controls">
        <button class="hawaii-nav-button hawaii-nav-prev" onclick="hawaiiGalleryPrev()">
          <span class="svg-wrapper">
            {{ 'icon-arrow.svg' | inline_asset_content }}
          </span>
        </button>
        <button class="hawaii-nav-button hawaii-nav-next" onclick="hawaiiGalleryNext()">
          <span class="svg-wrapper">
            {{ 'icon-arrow.svg' | inline_asset_content }}
          </span>
        </button>
      </div>
    {% endif %}
    
  </div>
</div>

<!-- Modal using Hawaii design -->
<div id="hawaii-media-modal" class="hawaii-modal" style="display: none;">
  <div class="hawaii-modal-backdrop" onclick="hawaiiCloseModal()"></div>
  <div class="hawaii-modal-content">
    <button class="hawaii-modal-close" onclick="hawaiiCloseModal()">
      <span class="svg-wrapper">
        {{ 'icon-close.svg' | inline_asset_content }}
      </span>
    </button>
    <div class="hawaii-modal-media-container">
      <!-- Dynamic content inserted here -->
    </div>
    <div class="hawaii-modal-caption"></div>
  </div>
</div>

{% stylesheet %}
  /* Hawaii Maker Studio Media Gallery Styles */
  .hawaii-media-gallery {
    position: relative;
  }
  
  /* Navigation using Hawaii design patterns */
  .hawaii-gallery-nav {
    margin-bottom: var(--gap-lg);
  }
  
  .hawaii-back-button {
    display: inline-flex;
    align-items: center;
    gap: var(--gap-xs);
    padding: var(--padding-sm) var(--padding-lg);
    border: var(--style-border-width) solid rgb(var(--color-border-rgb) / var(--opacity-50));
    border-radius: var(--style-border-radius-buttons-secondary);
    background: rgb(var(--color-background-rgb));
    color: rgb(var(--color-foreground-rgb));
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .hawaii-back-button:hover {
    background: rgb(var(--color-foreground-rgb) / var(--opacity-5));
    border-color: rgb(var(--color-border-rgb));
    transform: translateX(-2px);
  }
  
  .hawaii-back-button .svg-wrapper {
    transform: rotate(180deg);
    transition: transform 0.2s ease;
  }
  
  /* Gallery Container using Hawaii layout system */
  .hawaii-gallery-container {
    position: relative;
    width: 100%;
  }
  
  /* Mobile: horizontal scroll */
  @media (max-width: 749px) {
    .hawaii-gallery-container {
      display: flex !important;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      gap: var(--gap-md) !important;
      padding-bottom: var(--padding-sm);
    }
    
    .hawaii-gallery-container::-webkit-scrollbar {
      display: none;
    }
    
    .hawaii-media-item {
      flex: 0 0 calc(100vw / var(--mobile-columns, 2) - var(--gap-md));
      scroll-snap-align: start;
    }
  }
  
  /* Desktop: grid layout */
  @media (min-width: 750px) {
    .hawaii-gallery-container {
      display: grid;
      grid-template-columns: repeat(var(--desktop-columns, 4), 1fr);
      grid-auto-rows: 250px;
    }
    
    .hawaii-media-featured {
      grid-column: span 2;
      grid-row: span 2;
    }
  }
  
  /* Media Items using Hawaii styling */
  .hawaii-media-item {
    position: relative;
    overflow: hidden;
    background: rgb(var(--color-background-rgb));
    cursor: pointer;
    transition: all 0.3s ease;
    aspect-ratio: 1;
  }
  
  .hawaii-media-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgb(var(--color-shadow-rgb) / var(--opacity-15));
  }
  
  /* Images using Hawaii image styling */
  .hawaii-media-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: all 0.3s ease;
  }
  
  .hawaii-image-button {
    border: none;
    background: none;
    padding: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }
  
  .hawaii-image-button:hover .hawaii-media-image {
    transform: scale(1.05);
  }
  
  /* Video styling using Hawaii design */
  .hawaii-video-container {
    position: relative;
    width: 100%;
    height: 100%;
  }
  
  .hawaii-video,
  .hawaii-external-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .hawaii-video-controls {
    position: absolute;
    top: var(--padding-sm);
    right: var(--padding-sm);
    background: rgb(var(--color-background-rgb) / var(--opacity-90));
    border: var(--style-border-width) solid rgb(var(--color-border-rgb) / var(--opacity-30));
    border-radius: var(--style-border-radius-50);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
  }
  
  .hawaii-video-controls:hover {
    background: rgb(var(--color-background-rgb));
    transform: scale(1.1);
  }
  
  /* Captions using Hawaii text styling */
  .hawaii-media-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgb(var(--color-shadow-rgb) / var(--opacity-70)));
    color: var(--color-white);
    padding: var(--padding-lg) var(--padding-md) var(--padding-md);
    font-size: var(--font-size--sm);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .hawaii-media-item:hover .hawaii-media-caption {
    opacity: 1;
  }
  
  /* Gallery Controls using Hawaii button design */
  .hawaii-gallery-controls {
    display: flex;
    justify-content: center;
    gap: var(--gap-md);
    margin-top: var(--margin-lg);
  }
  
  .hawaii-nav-button {
    background: rgb(var(--color-primary-rgb));
    color: var(--color-white);
    border: none;
    border-radius: var(--style-border-radius-50);
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-button);
  }
  
  .hawaii-nav-button:hover {
    background: rgb(var(--color-primary-hover-rgb));
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgb(var(--color-shadow-rgb) / var(--opacity-25));
  }
  
  .hawaii-nav-prev .svg-wrapper {
    transform: rotate(180deg);
  }
  
  /* Modal using Hawaii design patterns */
  .hawaii-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: var(--layer-overlay);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .hawaii-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgb(var(--color-shadow-rgb) / var(--opacity-80));
    backdrop-filter: blur(10px);
  }
  
  .hawaii-modal-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    background: rgb(var(--color-background-rgb));
    border-radius: var(--style-border-radius-lg);
    overflow: hidden;
    box-shadow: 0 20px 60px rgb(var(--color-shadow-rgb) / var(--opacity-30));
  }
  
  .hawaii-modal-close {
    position: absolute;
    top: var(--padding-md);
    right: var(--padding-md);
    background: rgb(var(--color-background-rgb) / var(--opacity-90));
    border: none;
    border-radius: var(--style-border-radius-50);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: var(--layer-raised);
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
  }
  
  .hawaii-modal-close:hover {
    background: rgb(var(--color-background-rgb));
    transform: scale(1.1);
  }
  
  .hawaii-modal-media-container img {
    max-width: 100%;
    max-height: 90vh;
    width: auto;
    height: auto;
    object-fit: contain;
  }
  
  .hawaii-modal-caption {
    padding: var(--padding-lg);
    background: rgb(var(--color-background-rgb));
    color: rgb(var(--color-foreground-rgb));
    text-align: center;
    border-top: var(--style-border-width) solid rgb(var(--color-border-rgb) / var(--opacity-20));
  }
  
  /* Placeholder using Hawaii design */
  .hawaii-gallery-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    background: rgb(var(--color-background-rgb) / var(--opacity-50));
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
    text-align: center;
    flex-direction: column;
    gap: var(--gap-md);
  }
  
  .hawaii-placeholder-content .svg-wrapper {
    opacity: var(--opacity-30);
  }
  
  /* Responsive adjustments */
  @media (max-width: 749px) {
    .hawaii-gallery-controls {
      display: none;
    }
    
    .hawaii-media-item {
      min-height: 200px;
    }
  }
  
  /* CSS Custom Properties for JS */
  .hawaii-gallery-container {
    --desktop-columns: {{ section.settings.desktop_columns }};
    --mobile-columns: {{ section.settings.mobile_columns }};
  }
{% endstylesheet %}

<script>
// Hawaii Media Gallery JavaScript using native Hawaii design patterns
let hawaiiCurrentIndex = 0;
let hawaiiTotalImages = 0;

document.addEventListener('DOMContentLoaded', function() {
  hawaiiInitializeGallery();
});

function hawaiiInitializeGallery() {
  const container = document.querySelector('.hawaii-gallery-container');
  const images = document.querySelectorAll('.hawaii-media-item');
  hawaiiTotalImages = images.length;
  
  if (!container || hawaiiTotalImages === 0) return;
  
  const desktopColumns = parseInt(container.dataset.desktopColumns) || 4;
  const isDesktop = window.innerWidth >= 750;
  
  // Show initial images on desktop
  if (isDesktop && hawaiiTotalImages > desktopColumns * 2) {
    hawaiiShowImagesPage(0, desktopColumns * 2);
  }
  
  // Auto-start videos
  hawaiiStartAllVideos();
}

function hawaiiGalleryNext() {
  const container = document.querySelector('.hawaii-gallery-container');
  const desktopColumns = parseInt(container.dataset.desktopColumns) || 4;
  const imagesPerPage = desktopColumns * 2;
  
  if (window.innerWidth >= 750) {
    // Desktop pagination
    if ((hawaiiCurrentIndex + 1) * imagesPerPage < hawaiiTotalImages) {
      hawaiiCurrentIndex++;
      hawaiiShowImagesPage(hawaiiCurrentIndex * imagesPerPage, imagesPerPage);
    }
  } else {
    // Mobile scroll
    const scrollAmount = container.clientWidth * 0.8;
    container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
  }
}

function hawaiiGalleryPrev() {
  const container = document.querySelector('.hawaii-gallery-container');
  const desktopColumns = parseInt(container.dataset.desktopColumns) || 4;
  const imagesPerPage = desktopColumns * 2;
  
  if (window.innerWidth >= 750) {
    // Desktop pagination
    if (hawaiiCurrentIndex > 0) {
      hawaiiCurrentIndex--;
      hawaiiShowImagesPage(hawaiiCurrentIndex * imagesPerPage, imagesPerPage);
    }
  } else {
    // Mobile scroll
    const scrollAmount = container.clientWidth * 0.8;
    container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
  }
}

function hawaiiShowImagesPage(startIndex, count) {
  const images = document.querySelectorAll('.hawaii-media-item');
  
  images.forEach((img, index) => {
    if (index >= startIndex && index < startIndex + count) {
      img.style.display = 'block';
    } else {
      img.style.display = 'none';
    }
  });
}

function hawaiiOpenModal(imageUrl, caption) {
  const modal = document.getElementById('hawaii-media-modal');
  const mediaContainer = document.querySelector('.hawaii-modal-media-container');
  const captionContainer = document.querySelector('.hawaii-modal-caption');
  
  mediaContainer.innerHTML = `<img src="${imageUrl}" alt="Modal Image">`;
  captionContainer.textContent = caption || '';
  modal.style.display = 'flex';
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
}

function hawaiiCloseModal() {
  const modal = document.getElementById('hawaii-media-modal');
  modal.style.display = 'none';
  
  // Restore body scroll
  document.body.style.overflow = '';
}

function hawaiiToggleVideo(button) {
  const container = button.parentElement;
  const video = container.querySelector('.hawaii-video');
  const icon = button.querySelector('.svg-wrapper');
  
  if (video) {
    if (video.paused) {
      video.play();
      icon.innerHTML = '{{ 'icon-pause.svg' | inline_asset_content }}';
    } else {
      video.pause();
      icon.innerHTML = '{{ 'icon-play.svg' | inline_asset_content }}';
    }
  }
}

function hawaiiToggleExternalVideo(button) {
  const container = button.parentElement;
  const iframe = container.querySelector('iframe');
  const icon = button.querySelector('.svg-wrapper');
  
  if (iframe) {
    const src = iframe.src;
    if (src.includes('autoplay=1')) {
      iframe.src = src.replace('autoplay=1', 'autoplay=0');
      icon.innerHTML = '{{ 'icon-play.svg' | inline_asset_content }}';
    } else {
      iframe.src = src.includes('?') ? src + '&autoplay=1' : src + '?autoplay=1';
      icon.innerHTML = '{{ 'icon-pause.svg' | inline_asset_content }}';
    }
  }
}

function hawaiiStartAllVideos() {
  const videos = document.querySelectorAll('.hawaii-video');
  videos.forEach(video => {
    video.muted = true;
    video.loop = true;
    video.playsInline = true;
    video.play().catch(e => console.log('Autoplay prevented:', e));
  });
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    hawaiiCloseModal();
  }
});
</script>

{% schema %}
{
  "name": "Hawaii Media Gallery",
  "class": "section-wrapper",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section Width",
      "options": [
        {
          "value": "page-width",
          "label": "Page Width"
        },
        {
          "value": "full-width",
          "label": "Full Width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "select",
      "id": "gallery_layout",
      "label": "Gallery Layout",
      "options": [
        {
          "value": "row",
          "label": "Horizontal"
        },
        {
          "value": "column",
          "label": "Vertical"
        }
      ],
      "default": "row"
    },
    {
      "type": "range",
      "id": "desktop_columns",
      "label": "Desktop Columns",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "mobile_columns",
      "label": "Mobile Columns",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "image_gap",
      "label": "Image Gap",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "header",
      "content": "Media Settings"
    },
    {
      "type": "range",
      "id": "media_radius",
      "label": "Media Border Radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 20
    },
    {
      "type": "checkbox",
      "id": "show_captions",
      "label": "Show Image Captions",
      "default": false
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "border_style",
      "label": "Border Style",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "solid",
          "label": "Solid"
        }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "border_width",
      "label": "Border Width",
      "min": 0,
      "max": 5,
      "step": 1,
      "unit": "px",
      "default": 1,
      "visible_if": "{{ section.settings.border_style != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_opacity",
      "label": "Border Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ section.settings.border_style != 'none' }}"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "Hawaii Media Gallery"
    }
  ]
}
{% endschema %}
