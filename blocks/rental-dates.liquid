{%- liquid
  assign block_settings = block.settings
  assign product_id = closest.product.id
  assign product_form_id = 'BuyButtons-ProductForm-' | append: section.id
  assign start_date_id = 'RentalStart-' | append: product_id | append: '-' | append: block.id
  assign end_date_id = 'RentalEnd-' | append: product_id | append: '-' | append: block.id
  
  # Get today's date for min date
  assign today = 'now' | date: '%Y-%m-%d'
-%}

<rental-dates-component
  class="rental-dates spacing-style"
  style="{% render 'spacing-style', settings: block_settings %}"
  data-daily-rate="{{ block_settings.daily_rate | default: 0 }}"
  data-product-id="{{ product_id }}"
  {{ block.shopify_attributes }}
>
  {% if block_settings.heading != blank %}
    <h3 class="rental-dates__heading">
      {{ block_settings.heading | escape }}
    </h3>
  {% endif %}

  {% if block_settings.description != blank %}
    <p class="rental-dates__description">
      {{ block_settings.description | escape }}
    </p>
  {% endif %}

  <div class="rental-dates__fields">
    <div class="rental-dates__field">
      <label for="{{ start_date_id }}" class="field__label">
        {{ block_settings.start_date_label | default: 'Rental Start Date' | escape }}
        {% if block_settings.required %}
          <span class="required-asterisk">*</span>
        {% endif %}
      </label>
      <input
        type="date"
        id="{{ start_date_id }}"
        name="properties[Rental Start Date]"
        class="field__input rental-dates__date-input"
        form="{{ product_form_id }}"
        min="{{ today }}"
        ref="startDate"
        on:change="/handleDateChange"
        {% if block_settings.required %}
          required aria-required="true"
        {% endif %}
      >
    </div>

    <div class="rental-dates__field">
      <label for="{{ end_date_id }}" class="field__label">
        {{ block_settings.end_date_label | default: 'Rental End Date' | escape }}
        {% if block_settings.required %}
          <span class="required-asterisk">*</span>
        {% endif %}
      </label>
      <input
        type="date"
        id="{{ end_date_id }}"
        name="properties[Rental End Date]"
        class="field__input rental-dates__date-input"
        form="{{ product_form_id }}"
        min="{{ today }}"
        ref="endDate"
        on:change="/handleDateChange"
        {% if block_settings.required %}
          required aria-required="true"
        {% endif %}
      >
    </div>
  </div>

  <div class="rental-dates__summary" ref="summary" style="display: none;">
    <div class="rental-dates__duration">
      <strong>Rental Period:</strong> 
      <span ref="durationText">-</span>
    </div>
    {% if block_settings.daily_rate > 0 %}
      <div class="rental-dates__price">
        <strong>Rental Total:</strong> 
        <span ref="totalPrice">$0.00</span>
      </div>
    {% endif %}
  </div>

  <!-- Hidden inputs for additional data -->
  <input type="hidden" name="properties[Rental Duration]" ref="durationInput" form="{{ product_form_id }}">
  {% if block_settings.daily_rate > 0 %}
    <input type="hidden" name="properties[Daily Rate]" value="${{ block_settings.daily_rate }}" form="{{ product_form_id }}">
    <input type="hidden" name="properties[Rental Total]" ref="totalInput" form="{{ product_form_id }}">
  {% endif %}
</rental-dates-component>

{% stylesheet %}
  .rental-dates {
    border: 1px solid rgb(var(--color-border));
    border-radius: var(--border-radius);
    padding: 1rem;
    background: rgb(var(--color-background));
  }

  .rental-dates__heading {
    margin: 0 0 0.5rem 0;
    font-size: 1.1em;
    font-weight: 600;
  }

  .rental-dates__description {
    margin: 0 0 1rem 0;
    color: rgb(var(--color-foreground-75));
    font-size: 0.9em;
  }

  .rental-dates__fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  @media (max-width: 749px) {
    .rental-dates__fields {
      grid-template-columns: 1fr;
    }
  }

  .rental-dates__field {
    display: flex;
    flex-direction: column;
  }

  .rental-dates__date-input {
    margin-top: 0.25rem;
  }

  .rental-dates__summary {
    padding: 0.75rem;
    background: rgb(var(--color-background-2));
    border-radius: var(--border-radius);
    border: 1px solid rgb(var(--color-border-2));
  }

  .rental-dates__duration,
  .rental-dates__price {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  .rental-dates__duration:last-child,
  .rental-dates__price:last-child {
    margin-bottom: 0;
  }

  .required-asterisk {
    color: rgb(var(--color-error));
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Rental Dates",
  "tag": "rental-dates-component",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Select Rental Dates"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Choose your rental start and end dates."
    },
    {
      "type": "text",
      "id": "start_date_label",
      "label": "Start Date Label",
      "default": "Rental Start Date"
    },
    {
      "type": "text",
      "id": "end_date_label",
      "label": "End Date Label",
      "default": "Rental End Date"
    },
    {
      "type": "checkbox",
      "id": "required",
      "label": "Required",
      "default": true
    },
    {
      "type": "number",
      "id": "daily_rate",
      "label": "Daily Rental Rate ($)",
      "default": 0,
      "info": "Set to 0 to hide price calculation. Price will be calculated as: daily rate Ã— number of days"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "Left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "Right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Rental Dates",
      "category": "Product"
    }
  ]
}
{% endschema %}
